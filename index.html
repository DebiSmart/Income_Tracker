<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>הכנסות פלוס - ניהול עצמאי</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: #f8fafc; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent; bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }
        .dir-ltr { direction: ltr; }
        @keyframes chart-draw { from { stroke-dasharray: 1000; stroke-dashoffset: 1000; } to { stroke-dashoffset: 0; } }
        .animate-chart-draw { animation: chart-draw 2s ease-out forwards; }
        
        /* סגנון למסך שגיאה ראשוני */
        #error-display {
            display: none;
            padding: 20px;
            text-align: center;
            color: #e11d48;
        }
    </style>
</head>
<body>
    <!-- אלמנט השורש של React -->
    <div id="root">
        <div id="loading-state" style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; gap: 10px;">
            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="font-family: sans-serif; color: #64748b;">טוען מערכת...</p>
        </div>
    </div>

    <!-- תצוגת שגיאה במקרה של קריסת טעינה -->
    <div id="error-display">
        <h2 style="font-weight: bold;">אופס! המערכת לא הצליחה להיטען</h2>
        <p id="error-message" style="font-size: 14px; margin-top: 10px;"></p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px;">נסה שוב</button>
    </div>

    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // רכיב אייקון משופר - מונע קריסות אם הספרייה לא נטענה
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    try { window.lucide.createIcons(); } catch (e) { console.error(e); }
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={`inline-block shrink-0 ${className}`}></i>;
        };

        const PAYMENT_METHODS = [
            { id: 'paybox', label: 'פייבוקס', color: 'bg-blue-500' },
            { id: 'bit', label: 'ביט', color: 'bg-purple-500' },
            { id: 'cash', label: 'מזומן', color: 'bg-green-600' },
            { id: 'paybox2', label: 'פייבוקס 2', color: 'bg-blue-700' },
            { id: 'bit2', label: 'ביט 2', color: 'bg-purple-700' },
        ];

        const isWorkday = (year, month, day) => {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay(); // 0 = Sun, 5 = Fri, 6 = Sat
            return dayOfWeek !== 5 && dayOfWeek !== 6;
        };

        // רכיב Error Boundary פשוט בתוך React
        function App() {
            const [view, setView] = useState('input');
            const [entries, setEntries] = useState([]);
            const [target, setTarget] = useState(15000);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [scriptUrl, setScriptUrl] = useState('');

            const [amount, setAmount] = useState('');
            const [method, setMethod] = useState('bit');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

            // טעינה בטוחה של נתונים
            useEffect(() => {
                try {
                    const savedEntries = localStorage.getItem('income_entries');
                    const savedTarget = localStorage.getItem('income_target');
                    const savedUrl = localStorage.getItem('income_script_url');
                    
                    if (savedEntries) {
                        const parsed = JSON.parse(savedEntries);
                        if (Array.isArray(parsed)) setEntries(parsed);
                    }
                    if (savedTarget) setTarget(Number(savedTarget) || 15000);
                    if (savedUrl) setScriptUrl(savedUrl);
                } catch (e) {
                    console.error("Storage load error", e);
                }
            }, []);

            // שמירה בטוחה
            useEffect(() => {
                try {
                    localStorage.setItem('income_entries', JSON.stringify(entries));
                    localStorage.setItem('income_target', target.toString());
                    localStorage.setItem('income_script_url', scriptUrl);
                } catch (e) { console.error("Storage save error", e); }
            }, [entries, target, scriptUrl]);

            const stats = useMemo(() => {
                try {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                    const dayOfMonth = now.getDate();

                    let totalWorkdaysInMonth = 0;
                    let passedWorkdays = 0;
                    for (let d = 1; d <= daysInMonth; d++) {
                        if (isWorkday(currentYear, currentMonth, d)) {
                            totalWorkdaysInMonth++;
                            if (d <= dayOfMonth) passedWorkdays++;
                        }
                    }

                    const monthlyEntries = entries.filter(e => {
                        const eDate = new Date(e.date);
                        return eDate.getMonth() === currentMonth && eDate.getFullYear() === currentYear;
                    });

                    const totalActual = monthlyEntries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
                    const targetPerWorkday = target / (totalWorkdaysInMonth || 1);
                    const targetToDate = targetPerWorkday * passedWorkdays;
                    const projection = passedWorkdays > 0 ? (totalActual / passedWorkdays) * totalWorkdaysInMonth : 0;
                    const diff = totalActual - targetToDate;

                    const dailyData = [];
                    let cumulativeActual = 0;
                    let cumulativeTarget = 0;
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dayEntries = monthlyEntries.filter(e => new Date(e.date).getDate() === d);
                        cumulativeActual += dayEntries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
                        if (isWorkday(currentYear, currentMonth, d)) cumulativeTarget += targetPerWorkday;
                        dailyData.push({ day: d, actual: d <= dayOfMonth ? cumulativeActual : null, target: cumulativeTarget });
                    }

                    return { totalActual, targetToDate, projection, diff, percentage: (totalActual / target) * 100 || 0, totalWorkdaysInMonth, passedWorkdays, dailyData, daysInMonth, dayOfMonth, targetPerWorkday };
                } catch (e) {
                    return { totalActual: 0, targetToDate: 0, projection: 0, diff: 0, percentage: 0, dailyData: [] };
                }
            }, [entries, target]);

            const handleSaveEntry = async (e) => {
                if (e) e.preventDefault();
                if (!amount || isNaN(amount)) return;

                const newEntry = {
                    id: Date.now(),
                    amount: Number(amount),
                    method,
                    date: date || new Date().toISOString().split('T')[0],
                    timestamp: new Date().toLocaleString('he-IL')
                };

                setLoading(true);

                if (scriptUrl && scriptUrl.startsWith('http')) {
                    try {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 4000);
                        await fetch(scriptUrl, { 
                            method: 'POST', 
                            mode: 'no-cors', 
                            body: JSON.stringify(newEntry),
                            signal: controller.signal
                        });
                        clearTimeout(id);
                    } catch (err) { console.warn("Sync warning", err); }
                }

                setEntries(prev => [newEntry, ...prev]);
                setAmount('');
                setMessage({ text: 'ההכנסה נשמרה!' });
                setLoading(false);
                setTimeout(() => setMessage(null), 3000);
            };

            return (
                <div className="min-h-screen pb-24">
                    <header className="bg-white p-6 border-b sticky top-0 z-10 shadow-sm flex justify-between items-center max-w-md mx-auto">
                        <div>
                            <h1 className="text-xl font-black text-slate-900">הכנסות פלוס</h1>
                            <p className="text-slate-400 text-[10px] font-bold tracking-tight">ניהול פיננסי לעצמאי</p>
                        </div>
                        <button onClick={() => setView('settings')} className="text-slate-400 p-2"><Icon name="settings" size={20} /></button>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        {message && (
                            <div className="bg-emerald-600 text-white p-4 rounded-2xl text-center font-bold text-sm shadow-lg animate-in zoom-in duration-300">
                                {message.text}
                            </div>
                        )}

                        {view === 'input' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                    <form onSubmit={handleSaveEntry} className="space-y-5">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 mb-2 mr-1">סכום הכנסה</label>
                                            <input 
                                                type="number" inputMode="decimal" value={amount} onChange={e => setAmount(e.target.value)}
                                                placeholder="₪0.00" className="w-full text-4xl font-black p-5 bg-slate-50 rounded-2xl text-center outline-none focus:ring-2 focus:ring-blue-500" required
                                            />
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {PAYMENT_METHODS.map(m => (
                                                <button key={m.id} type="button" onClick={() => setMethod(m.id)} className={`p-3 rounded-xl text-xs font-bold transition-all ${method === m.id ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-500'}`}>
                                                    {m.label}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="relative">
                                            <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl text-right pr-12 font-bold text-slate-700 outline-none" />
                                            <div className="absolute right-4 top-4 text-slate-400 pointer-events-none"><Icon name="calendar" size={18} /></div>
                                        </div>
                                        <button disabled={loading || !amount} className="w-full bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-xl active:scale-95 disabled:opacity-50 transition-all flex justify-center items-center gap-2">
                                            {loading ? <Icon name="loader-2" className="animate-spin" size={20} /> : <><Icon name="save" size={20} /> שמור הכנסה</>}
                                        </button>
                                    </form>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-emerald-50 p-5 rounded-3xl border border-emerald-100 text-center">
                                        <p className="text-emerald-600 text-[10px] font-bold mb-1 uppercase tracking-wider">סה"כ החודש</p>
                                        <p className="text-emerald-700 text-2xl font-black">₪{stats.totalActual.toLocaleString()}</p>
                                    </div>
                                    <div className="bg-blue-50 p-5 rounded-3xl border border-blue-100 text-center">
                                        <p className="text-blue-600 text-[10px] font-bold mb-1 uppercase tracking-wider">צפי סוף חודש</p>
                                        <p className="text-blue-700 text-2xl font-black">₪{Math.round(stats.projection).toLocaleString()}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                    <div className={`p-5 rounded-2xl mb-6 flex justify-between items-center ${stats.diff >= 0 ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-rose-50 text-rose-700 border-rose-100'} border`}>
                                        <div>
                                            <p className="text-[10px] font-bold uppercase mb-1">ביצוע מול יעד נוכחי</p>
                                            <p className="text-3xl font-black">{stats.diff >= 0 ? '+' : ''}₪{Math.round(Math.abs(stats.diff)).toLocaleString()}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-[10px] font-bold mb-1 opacity-70">יום עבודה {stats.passedWorkdays}</p>
                                            <p className="text-xs font-black">מתוך {stats.totalWorkdaysInMonth}</p>
                                        </div>
                                    </div>

                                    <div className="mb-6 px-1">
                                        <div className="flex justify-between items-end mb-2">
                                            <span className="text-xs font-bold text-slate-400">התקדמות יעד</span>
                                            <span className="text-sm font-black text-blue-600">{Math.round(stats.percentage)}%</span>
                                        </div>
                                        <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                                            <div style={{width: `${Math.min(stats.percentage, 100)}%`}} className="h-full bg-blue-500 transition-all duration-1000"></div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 rounded-2xl p-5 overflow-hidden">
                                        <svg viewBox="0 0 300 150" className="w-full overflow-visible">
                                            <path d={`M 0 150 L ${stats.dailyData.map(d => `${(d.day/stats.daysInMonth)*300},${150 - (d.target/Math.max(target, stats.totalActual || 1)*150)}`).join(' L ')}`} fill="none" stroke="#cbd5e1" strokeWidth="1" strokeDasharray="4 2" />
                                            <path 
                                                d={`M 0 150 L ${stats.dailyData.filter(d => d.actual !== null).map(d => `${(d.day/stats.daysInMonth)*300},${150 - (d.actual/Math.max(target, stats.totalActual || 1)*150)}`).join(' L ')}`} 
                                                fill="none" stroke="#3b82f6" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="animate-chart-draw"
                                            />
                                        </svg>
                                        <div className="flex justify-between mt-3 text-[9px] text-slate-400 font-bold px-1">
                                            <span>1 לחודש</span>
                                            <span>{stats.daysInMonth} לחודש</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 space-y-8 animate-in slide-in-from-right-4 duration-500">
                                <div>
                                    <label className="block text-sm font-bold text-slate-500 mb-3 mr-1">יעד הכנסה חודשי</label>
                                    <input type="number" value={target} onChange={e => setTarget(Number(e.target.value) || 0)} className="w-full p-5 bg-slate-50 rounded-2xl font-black text-2xl text-center outline-none focus:ring-2 focus:ring-slate-200" />
                                    <p className="mt-2 text-[10px] text-center text-slate-400 italic">₪{Math.round(stats.targetPerWorkday).toLocaleString()} לכל יום עבודה</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-emerald-600 mb-3 mr-1">Google Sheets Script URL</label>
                                    <input type="text" value={scriptUrl} onChange={e => setScriptUrl(e.target.value)} className="w-full p-4 bg-slate-50 rounded-xl text-[10px] dir-ltr border border-slate-200 outline-none" placeholder="https://script.google.com/..." />
                                </div>
                                <button onClick={() => { if(window.confirm('לאפס את כל הנתונים המקומיים?')) { setEntries([]); localStorage.removeItem('income_entries'); } }} className="w-full text-rose-500 text-[10px] font-bold py-3 border border-rose-100 rounded-xl hover:bg-rose-50 transition-all uppercase tracking-widest">איפוס נתונים</button>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-t border-slate-100 p-4 pb-8 flex justify-around max-w-md mx-auto shadow-lg rounded-t-[2.5rem]">
                        <button onClick={() => setView('input')} className={`flex flex-col items-center gap-1 transition-all ${view === 'input' ? 'text-blue-600 scale-110' : 'text-slate-300'}`}>
                            <Icon name="plus-circle" size={28} />
                            <span className="text-[9px] font-black uppercase tracking-tighter">הזנה</span>
                        </button>
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1 transition-all ${view === 'dashboard' ? 'text-blue-600 scale-110' : 'text-slate-300'}`}>
                            <Icon name="bar-chart-3" size={28} />
                            <span className="text-[9px] font-black uppercase tracking-tighter">ניתוח</span>
                        </button>
                    </nav>
                </div>
            );
        }

        // ניסיון הרצה ובדיקת שגיאות
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (e) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-message').innerText = "שגיאת טעינה: " + e.message;
        }
    </script>
</body>
</html>
